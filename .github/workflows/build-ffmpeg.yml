name: Build FFmpeg Linux

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            image: quay.io/pypa/manylinux_2_28_x86_64
          - arch: aarch64
            runner: ubuntu-24.04-arm  # Native ARM64 runner (free for public repos)
            image: quay.io/pypa/manylinux_2_28_aarch64
    
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          yum install -y epel-release || true
          # Sometimes epel-release is not directly avail via yum in bare images, check dnf
          if ! rpm -q epel-release; then
             dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm || true
          fi
          
          # Install development tools and library dependencies
          # Note: We removed openssl-devel to use our vendor-provided static library
          yum install -y gcc gcc-c++ make yasm nasm git wget tar gzip \
                         freetype-devel libass-devel \
                         zlib-devel bzip2

      - name: Download FFmpeg 5.1.8
        run: |
          wget https://ffmpeg.org/releases/ffmpeg-5.1.8.tar.bz2
          tar -xjf ffmpeg-5.1.8.tar.bz2
          mv ffmpeg-5.1.8 ffmpeg-src

      - name: Configure and Build
        working-directory: ffmpeg-src
        run: |
          # Define OpenSSL path relative to workspace (architecture-specific)
          OPENSSL_DIR="${GITHUB_WORKSPACE}/vendor/openssl/linux-${{ matrix.arch }}"
          
          # Fix hardcoded paths in .pc files (they were built with --prefix=/opt/openssl)
          sed -i "s|/opt/openssl/lib64|${OPENSSL_DIR}/lib|g" ${OPENSSL_DIR}/lib/pkgconfig/*.pc
          sed -i "s|/opt/openssl/lib|${OPENSSL_DIR}/lib|g" ${OPENSSL_DIR}/lib/pkgconfig/*.pc
          sed -i "s|/opt/openssl/include|${OPENSSL_DIR}/include|g" ${OPENSSL_DIR}/lib/pkgconfig/*.pc
          
          # Set PKG_CONFIG_PATH so FFmpeg's configure can find OpenSSL
          export PKG_CONFIG_PATH="${OPENSSL_DIR}/lib/pkgconfig:${PKG_CONFIG_PATH}"
          
          ./configure --prefix=./install \
           --disable-everything \
           --enable-shared --disable-static \
           --enable-network --enable-runtime-cpudetect \
           --enable-openssl \
           --enable-avformat --enable-avcodec --enable-avutil --enable-swscale --enable-swresample \
           --enable-protocol=tcp,udp,rtp,rtmp,rtmps,http,https,tls,file,hls,concat \
           --enable-demuxer=flv,mpegts,mov,mp4,h264,hevc,webm,rtsp,sdp,rtp,matroska,avi,mp3,aac,wav,image2,gif,concat,ass,subrip,webvtt \
           --enable-decoder=h264,hevc,mpeg4,mpeg2video,mjpeg,png,bmp,gif,webp,vp8,vp9,aac,mp3,ac3,eac3,pcm_s16le,pcm_s24le,pcm_s32le,pcm_f32le,flac,vorbis,opus,ass,subrip,dvdsub,pgssub,dca,truehd,mlp \
           --enable-parser=h264,hevc,mpeg4video,mjpeg,aac,mpegaudio,ac3,flac,vorbis,opus,vp9,dca,truehd,mlp \
           --enable-bsf=h264_mp4toannexb,hevc_mp4toannexb,aac_adtstoasc \
           --disable-debug --disable-doc \
           --extra-cflags="-I${OPENSSL_DIR}/include -O3" \
           --extra-ldflags="-L${OPENSSL_DIR}/lib" \
           --pkg-config-flags="--static" \
           --enable-filter=subtitles,scale,yadif,colorspace,drawtext \
           --enable-libfreetype --enable-libass \
           --arch=${{ matrix.arch }}
           
           make -j$(nproc)
           make install

      - name: Package Release
        run: |
          cd ffmpeg-src/install
          # Create a tarball of the install directory (includes lib, include, bin, share)
          tar -czvf ../../ffmpeg-5.1.8-linux-${{ matrix.arch }}.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-build-${{ matrix.arch }}
          path: ffmpeg-5.1.8-linux-${{ matrix.arch }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
