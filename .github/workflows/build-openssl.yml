name: Build OpenSSL Static Linux

on:
  workflow_dispatch:
    inputs:
      openssl_version:
        description: 'OpenSSL version to build'
        required: false
        default: '3.3.1'
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            image: quay.io/pypa/manylinux_2_28_x86_64
            openssl_target: linux-x86_64
            lib_dir: lib64
          - arch: aarch64
            image: quay.io/pypa/manylinux_2_28_aarch64
            openssl_target: linux-aarch64
            lib_dir: lib
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # QEMU is required for running aarch64 containers on x86_64 runners
      - name: Set up QEMU
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build OpenSSL in Container
        run: |
          OPENSSL_VERSION="${{ github.event.inputs.openssl_version || '3.3.1' }}"
          
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            --platform linux/${{ matrix.arch == 'aarch64' && 'arm64' || 'amd64' }} \
            ${{ matrix.image }} \
            bash -c "
              # Install dependencies
              yum install -y epel-release || true
              if ! rpm -q epel-release; then
                dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm || true
              fi
              yum install -y gcc gcc-c++ make perl wget tar gzip
              
              # Download OpenSSL
              wget https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz
              tar -xzf openssl-${OPENSSL_VERSION}.tar.gz
              cd openssl-${OPENSSL_VERSION}
              
              # Configure and build
              ./Configure ${{ matrix.openssl_target }} \
                --prefix=/opt/openssl \
                --openssldir=/opt/openssl/ssl \
                no-shared \
                no-tests \
                no-apps \
                -fPIC
              
              make -j\$(nproc) build_libs
              make install_sw
              
              # Package
              mkdir -p /workspace/openssl-package
              cp -r /opt/openssl/include /workspace/openssl-package/
              cp -r /opt/openssl/${{ matrix.lib_dir }} /workspace/openssl-package/lib
              
              # Version info
              echo \"OpenSSL ${OPENSSL_VERSION}\" > /workspace/openssl-package/VERSION
              echo \"Built with manylinux_2_28_${{ matrix.arch }}\" >> /workspace/openssl-package/VERSION
              echo \"Static libraries for Linux ${{ matrix.arch }}\" >> /workspace/openssl-package/VERSION
              echo \"Build date: \$(date -u +%Y-%m-%dT%H:%M:%SZ)\" >> /workspace/openssl-package/VERSION
              
              # Create tarball
              cd /workspace/openssl-package
              tar -czvf /workspace/openssl-${OPENSSL_VERSION}-linux-${{ matrix.arch }}-static.tar.gz .
            "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-static-${{ matrix.arch }}
          path: openssl-*-linux-${{ matrix.arch }}-static.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: openssl-${{ github.event.inputs.openssl_version || '3.3.1' }}
          name: OpenSSL ${{ github.event.inputs.openssl_version || '3.3.1' }} Static Build
          body: |
            ## OpenSSL ${{ github.event.inputs.openssl_version || '3.3.1' }} Static Build for Linux
            
            This release contains statically compiled OpenSSL libraries for multiple architectures.
            
            ### Build Environment
            - **Container**: `quay.io/pypa/manylinux_2_28_*`
            - **glibc**: 2.28+ compatible
            
            ### Available Architectures
            - **x86_64**: For 64-bit Intel/AMD processors
            - **aarch64**: For 64-bit ARM processors (e.g., AWS Graviton, Raspberry Pi 4)
            
            ### Contents
            - `include/` - Header files
            - `lib/` - Static libraries (libssl.a, libcrypto.a)
            
            ### Usage
            Link with `-lssl -lcrypto -lpthread -ldl` when using these static libraries.
          files: artifacts/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
