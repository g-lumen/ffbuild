name: Build OpenSSL Static

on:
  workflow_dispatch:
    inputs:
      openssl_version:
        description: 'OpenSSL version to build'
        required: false
        default: '3.3.1'
        type: string

permissions:
  contents: write

jobs:
  # ============================================
  # Linux Builds (x86_64 and aarch64)
  # ============================================
  build-linux:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            image: quay.io/pypa/manylinux_2_28_x86_64
            openssl_target: linux-x86_64
            lib_dir: lib64
          - arch: aarch64
            runner: ubuntu-24.04-arm  # Native ARM64 runner (free for public repos)
            image: quay.io/pypa/manylinux_2_28_aarch64
            openssl_target: linux-aarch64
            lib_dir: lib
    
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          yum install -y epel-release || true
          if ! rpm -q epel-release; then
            dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm || true
          fi
          yum install -y gcc gcc-c++ make perl wget tar gzip

      - name: Download OpenSSL
        run: |
          OPENSSL_VERSION="${{ github.event.inputs.openssl_version || '3.3.1' }}"
          echo "Building OpenSSL version: ${OPENSSL_VERSION}"
          wget https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz
          tar -xzf openssl-${OPENSSL_VERSION}.tar.gz
          mv openssl-${OPENSSL_VERSION} openssl-src

      - name: Configure and Build OpenSSL
        working-directory: openssl-src
        run: |
          # Configure OpenSSL for static library build
          # no-shared: Build only static libraries (generates .a files)
          # no-tests: Skip building tests to speed up compilation
          # no-apps: Skip building command-line tools (avoids static linking issues)
          # -fPIC: Position Independent Code (useful if static lib is used in shared lib)
          ./Configure ${{ matrix.openssl_target }} \
            --prefix=/opt/openssl \
            --openssldir=/opt/openssl/ssl \
            no-shared \
            no-tests \
            no-apps \
            -fPIC
          
          # Build only libraries
          make -j$(nproc) build_libs
          
          # Install libraries and headers
          make install_sw

      - name: Package Release
        run: |
          OPENSSL_VERSION="${{ github.event.inputs.openssl_version || '3.3.1' }}"
          
          # Create package directory
          mkdir -p openssl-package
          
          # Copy necessary files (headers and static libraries only)
          cp -r /opt/openssl/include openssl-package/
          cp -r /opt/openssl/${{ matrix.lib_dir }} openssl-package/lib
          
          # Create version info
          echo "OpenSSL ${OPENSSL_VERSION}" > openssl-package/VERSION
          echo "Built with manylinux_2_28_${{ matrix.arch }}" >> openssl-package/VERSION
          echo "Static libraries for Linux ${{ matrix.arch }}" >> openssl-package/VERSION
          echo "Build date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> openssl-package/VERSION
          
          # Create tarball
          cd openssl-package
          tar -czvf ../openssl-${OPENSSL_VERSION}-linux-${{ matrix.arch }}-static.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-linux-${{ matrix.arch }}
          path: openssl-*-linux-${{ matrix.arch }}-static.tar.gz

  # ============================================
  # macOS Builds (x86_64 and arm64)
  # ============================================
  build-macos:
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: macos-15-intel  # New migration tag for Intel x64 on macOS 15
            openssl_target: darwin64-x86_64-cc
          - arch: arm64
            runner: macos-15        # Apple Silicon (M1/M2) runner on macOS 15
            openssl_target: darwin64-arm64-cc
    
    runs-on: ${{ matrix.runner }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # Perl is pre-installed on macOS runners
          # Install any additional tools if needed
          brew install wget || true

      - name: Download OpenSSL
        run: |
          OPENSSL_VERSION="${{ github.event.inputs.openssl_version || '3.3.1' }}"
          echo "Building OpenSSL version: ${OPENSSL_VERSION}"
          wget https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz
          tar -xzf openssl-${OPENSSL_VERSION}.tar.gz
          mv openssl-${OPENSSL_VERSION} openssl-src

      - name: Configure and Build OpenSSL
        working-directory: openssl-src
        run: |
          # Configure OpenSSL for static library build on macOS
          # no-shared: Build only static libraries (generates .a files)
          # no-tests: Skip building tests to speed up compilation
          # no-apps: Skip building command-line tools
          ./Configure ${{ matrix.openssl_target }} \
            --prefix=/opt/openssl \
            --openssldir=/opt/openssl/ssl \
            no-shared \
            no-tests \
            no-apps
          
          # Build only libraries
          make -j$(sysctl -n hw.ncpu) build_libs
          
          # Install libraries and headers
          sudo make install_sw

      - name: Package Release
        run: |
          OPENSSL_VERSION="${{ github.event.inputs.openssl_version || '3.3.1' }}"
          
          # Create package directory
          mkdir -p openssl-package
          
          # Copy necessary files (headers and static libraries only)
          # On macOS, libraries are in 'lib' directory
          cp -r /opt/openssl/include openssl-package/
          cp -r /opt/openssl/lib openssl-package/
          
          # Create version info
          echo "OpenSSL ${OPENSSL_VERSION}" > openssl-package/VERSION
          echo "Built on macOS ${{ matrix.runner }}" >> openssl-package/VERSION
          echo "Static libraries for macOS ${{ matrix.arch }}" >> openssl-package/VERSION
          echo "Build date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> openssl-package/VERSION
          
          # Create tarball
          cd openssl-package
          tar -czvf ../openssl-${OPENSSL_VERSION}-macos-${{ matrix.arch }}-static.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-macos-${{ matrix.arch }}
          path: openssl-*-macos-${{ matrix.arch }}-static.tar.gz

  # ============================================
  # Release job
  # ============================================
  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: openssl-${{ github.event.inputs.openssl_version || '3.3.1' }}
          name: OpenSSL ${{ github.event.inputs.openssl_version || '3.3.1' }} Static Build
          body: |
            ## OpenSSL ${{ github.event.inputs.openssl_version || '3.3.1' }} Static Build
            
            This release contains statically compiled OpenSSL libraries for multiple platforms and architectures.
            
            ### Linux Build Environment
            - **Container**: `quay.io/pypa/manylinux_2_28_*`
            - **glibc**: 2.28+ compatible
            
            ### macOS Build Environment
            - **Intel (x86_64)**: Built on macos-15-intel runner
            - **Apple Silicon (arm64)**: Built on macos-15 runner
            
            ### Available Platforms & Architectures
            
            #### Linux
            - **x86_64**: For 64-bit Intel/AMD processors
            - **aarch64**: For 64-bit ARM processors (e.g., AWS Graviton, Raspberry Pi 4)
            
            #### macOS
            - **x86_64**: For Intel Macs
            - **arm64**: For Apple Silicon Macs (M1/M2/M3)
            
            ### Contents
            - `include/` - Header files
            - `lib/` - Static libraries (libssl.a, libcrypto.a)
            
            ### Usage
            - **Linux**: Link with `-lssl -lcrypto -lpthread -ldl`
            - **macOS**: Link with `-lssl -lcrypto`
          files: artifacts/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
